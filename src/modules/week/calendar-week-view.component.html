<div class="cal-week-view">
  <mwl-calendar-week-view-header
    [days]="days"
    [locale]="locale"
    [customTemplate]="headerTemplate"
    [resources]="resources"
    (dayHeaderClicked)="dayHeaderClicked.emit($event)"
    (eventDropped)="eventDropped({dropData: $event}, $event.newStart, true)">
  </mwl-calendar-week-view-header>
  <div class="cal-all-day-events"
    #allDayEventsContainer
    *ngIf="view.allDayEventRows.length > 0"
    mwlDroppable
    (dragEnter)="eventDragEnter = eventDragEnter + 1"
    (dragLeave)="eventDragEnter = eventDragEnter - 1">
    <div class="cal-day-columns">
      <div class="cal-time-label-column"
        [ngTemplateOutlet]="allDayEventsLabelTemplate">
      </div>
      <div class="cal-day-column"
        *ngFor="let day of days; trackBy:trackByWeekDayHeaderDate"
        mwlDroppable
        dragOverClass="cal-drag-over"
        (drop)="eventDropped($event, day.date, true)">
      </div>
    </div>
    <div class="cal-events-row" #eventRowContainer
      *ngFor="let eventRow of view.allDayEventRows; trackBy:trackByIndex">
      <div class="cal-event-container" #event
        *ngFor="let allDayEvent of eventRow.row; trackBy:trackByDayOrWeekEvent"
        [class.cal-draggable]="allDayEvent.event.draggable && allDayEventResizes.size === 0"
        [class.cal-starts-within-week]="!allDayEvent.startsBeforeWeek"
        [class.cal-ends-within-week]="!allDayEvent.endsAfterWeek"
        [ngClass]="allDayEvent.event?.cssClass"
        [style.width]="((100 / days.length) * allDayEvent.span) + '%'"
        [style.marginLeft]="((100 / days.length) * allDayEvent.offset) + '%'"
        mwlResizable
        [resizeEdges]="{
          left: allDayEvent.event?.resizable?.beforeStart,
          right: allDayEvent.event?.resizable?.afterEnd
        }"
        [resizeSnapGrid]="{left: dayColumnWidth, right: dayColumnWidth}"
        [validateResize]="validateResize"
        (resizeStart)="allDayEventResizeStarted(eventRowContainer, allDayEvent, $event)"
        (resizing)="allDayEventResizing(allDayEvent, $event, dayColumnWidth)"
        (resizeEnd)="allDayEventResizeEnded(allDayEvent)"
        mwlDraggable
        dragActiveClass="cal-drag-active"
        [dropData]="{event: allDayEvent.event}"
        [dragAxis]="{
          x: allDayEvent.event.draggable && allDayEventResizes.size === 0,
          y: !snapDraggedEvents && allDayEvent.event.draggable && allDayEventResizes.size === 0
        }"
        [dragSnapGrid]="snapDraggedEvents ? {x: dayColumnWidth} : {}"
        [validateDrag]="snapDraggedEvents ? validateDrag : false"
        (dragPointerDown)="dragStarted(eventRowContainer, event)"
        (dragEnd)="dragEnded(allDayEvent, $event)">
        <mwl-calendar-week-view-event
          [weekEvent]="allDayEvent"
          [tooltipPlacement]="tooltipPlacement"
          [tooltipTemplate]="tooltipTemplate"
          [tooltipAppendToBody]="tooltipAppendToBody"
          [customTemplate]="eventTemplate"
          [eventTitleTemplate]="eventTitleTemplate"
          (eventClicked)="eventClicked.emit({event: allDayEvent.event})">
        </mwl-calendar-week-view-event>
      </div>
    </div>
  </div>
  <div class="cal-time-events"
    mwlDroppable
    (dragEnter)="eventDragEnter = eventDragEnter + 1"
    (dragLeave)="eventDragEnter = eventDragEnter - 1">
    <div class="cal-time-label-column" *ngIf="view.hourColumns.length > 0">
      <div class="cal-hour"
        *ngFor="let hour of view.hourColumns[0].hours; trackBy:trackByHour; let odd = odd"
        [class.cal-hour-odd]="odd">
        <mwl-calendar-week-view-hour-segment
          *ngFor="let segment of hour.segments; trackBy:trackByHourSegment"
          [style.height.px]="hourSegmentHeight"
          [segment]="segment"
          [segmentHeight]="hourSegmentHeight"
          [locale]="locale"
          [customTemplate]="hourSegmentTemplate"
          [isTimeLabel]="true">
        </mwl-calendar-week-view-hour-segment>
      </div>
    </div>
    <div class="cal-day-columns" #dayColumns
      [class.cal-resize-active]="timeEventResizes.size > 0">
      <div class="cal-day-column"
        *ngFor="let column of view.hourColumns; trackBy:trackByHourColumn">

        <div class="cal-resource-columns" #resourceColumns>
          <div class="cal-resource-column"
            *ngFor="let resource of resources"
            [style.width.%]="100 / resources?.length">
            <div *ngFor="let timeEvent of column.events; trackBy:trackByDayOrWeekEvent">
              <div class="cal-event-container" #event
                *ngIf="timeEvent.event?.resourceId === resource.id"
                [class.cal-background]="timeEvent.event.background"
                [class.cal-draggable]="timeEvent.event.draggable && timeEventResizes.size === 0"
                [class.cal-starts-within-day]="!timeEvent.startsBeforeDay"
                [class.cal-ends-within-day]="!timeEvent.endsAfterDay"
                [ngClass]="timeEvent.event.cssClass"
                [hidden]="timeEvent.height === 0 && timeEvent.width === 0"
                [style.top.px]="timeEvent.top"
                [style.height.px]="timeEvent.height"
                [style.left.%]="0"
                [style.width.%]="100"
                mwlResizable
                [resizeSnapGrid]="{left: dayColumnWidth, right: dayColumnWidth, top: eventSnapSize || hourSegmentHeight, bottom: eventSnapSize || hourSegmentHeight}"
                [validateResize]="validateResize"
                [allowNegativeResizes]="true"
                (resizeStart)="timeEventResizeStarted(dayColumns, timeEvent, $event)"
                (resizing)="timeEventResizing(timeEvent, $event)"
                (resizeEnd)="timeEventResizeEnded(timeEvent)"
                mwlDraggable
                dragActiveClass="cal-drag-active"
                [dropData]="{event: timeEvent.event}"
                [dragAxis]="{
                  x: timeEvent.event.draggable && timeEventResizes.size === 0,
                  y: timeEvent.event.draggable && timeEventResizes.size === 0
                }"
                [dragSnapGrid]="snapDraggedEvents ? {x: resourceColumnWidth, y: eventSnapSize || hourSegmentHeight} : {}"
                [ghostDragEnabled]="!snapDraggedEvents"
                [validateDrag]="snapDraggedEvents ? validateDrag : false"
                (dragPointerDown)="dragStarted(dayColumns, event, timeEvent)"
                (dragging)="dragMove(timeEvent, $event)"
                (dragEnd)="dragEnded(timeEvent, $event, true)">
                <div
                  class="cal-resize-handle cal-resize-handle-before-start"
                  *ngIf="timeEvent.event?.resizable?.beforeStart && !timeEvent.startsBeforeDay"
                  mwlResizeHandle
                  [resizeEdges]="{
                    left: true,
                    top: true
                  }">
                </div>
                <mwl-calendar-week-view-event
                  [weekEvent]="timeEvent"
                  [tooltipPlacement]="tooltipPlacement"
                  [tooltipTemplate]="tooltipTemplate"
                  [tooltipAppendToBody]="tooltipAppendToBody"
                  [tooltipDisabled]="dragActive || timeEventResizes.size > 0"
                  [customTemplate]="eventTemplate"
                  [eventTitleTemplate]="eventTitleTemplate"
                  (eventClicked)="eventClicked.emit({event: timeEvent.event})">
                </mwl-calendar-week-view-event>
                <div
                  class="cal-resize-handle cal-resize-handle-after-end"
                  *ngIf="timeEvent.event?.resizable?.afterEnd && !timeEvent.endsAfterDay"
                  mwlResizeHandle
                  [resizeEdges]="{
                    right: true,
                    bottom: true
                  }">
                </div>
              </div>
            </div>

            <div class="cal-hour"
              *ngFor="let hour of column.hours; trackBy:trackByHour; let odd = odd"
              [class.cal-hour-odd]="odd">
              <mwl-calendar-week-view-hour-segment
                *ngFor="let segment of hour.segments; trackBy:trackByHourSegment"
                [style.height.px]="hourSegmentHeight"
                [segment]="segment"
                [segmentHeight]="hourSegmentHeight"
                [locale]="locale"
                [customTemplate]="hourSegmentTemplate"
                [resource]="resource"
                (mwlClick)="hourSegmentClicked.emit({date: segment.date, resourceId: resource?.id})"
                mwlDroppable
                [dragOverClass]="!dragActive || !snapDraggedEvents ? 'cal-drag-over' : null"
                (drop)="eventDropped($event, segment.date, false)">
              </mwl-calendar-week-view-hour-segment>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
